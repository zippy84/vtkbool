FROM archlinux:latest
RUN pacman -Syyu --noconfirm
RUN pacman -S cmake vtk make gcc libjpeg-turbo libpng libtiff python-pytest openmpi fmt python gcovr clang openmp python-pygments --noconfirm

WORKDIR /master
COPY . .
RUN ls -alh
WORKDIR /master/build
RUN cmake -DCMAKE_BUILD_TYPE=PROFILE -DVTKBOOL_COVERAGE=ON ..
RUN make
RUN ctest --output-on-failure
RUN gcovr -r .. . --exclude-throw-branches --cobertura-pretty -o coverage.xml
RUN gcovr -r .. . --exclude-throw-branches --html-details -o coverage.html

WORKDIR /master2
COPY . .
RUN ls -alh
WORKDIR /master2/build
RUN CXX=clang++ CC=clang cmake -DCMAKE_BUILD_TYPE=RELEASE ..
RUN make
RUN ctest --output-on-failure
